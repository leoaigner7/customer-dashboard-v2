name: Build & Release

on:
  push:
    tags:
      - "*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Get version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

    - name: Detect major version
      run: echo "MAJOR=${VERSION%%.*}" >> $GITHUB_ENV

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    ###########################################################################
    # BUILD DOCKER IMAGE FOR BOTH V1 AND V2
    ###########################################################################

    - name: Build image
      run: |
        docker build \
          -t ghcr.io/${{ github.repository_owner }}/customer-dashboard:${VERSION} .

    - name: Push image
      run: docker push ghcr.io/${{ github.repository_owner }}/customer-dashboard:${VERSION}

    ###########################################################################
    # PACKAGE CREATION
    ###########################################################################

    - name: Create Release Package
      run: |
        mkdir package

        if [ "$MAJOR" = "1" ]; then
          echo "ðŸ“¦ Creating LEGACY v1 package..."

          cp deploy/docker-compose.yml package/
          cp deploy/.env.example package/.env
          echo "APP_VERSION=${VERSION}" >> package/.env
          echo ${VERSION} > package/VERSION.txt

          # include old HTML version
          mkdir package/app
          cp -r app/public package/app/public
          cp app/server.js package/app/server.js
          cp app/package.json package/app/package.json

        else
          echo "ðŸš€ Creating NEW v2 package..."

          # docker compose v2 specific release folder
          mkdir package/data

          cp deploy/docker-compose.yml package/
          cp deploy/.env.example package/.env
          echo "APP_VERSION=${VERSION}" >> package/.env
          echo ${VERSION} > package/VERSION.txt

          # no source code included
          # runtime uses GHCR image only
        fi

        cd package
        zip -r ../customer-dashboard-${VERSION}.zip .

    ###########################################################################
    # UPLOAD RELEASE
    ###########################################################################

    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        files: customer-dashboard-${{ env.VERSION }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
